# 第 1 章 仮実装

-   第 1 部を通して、多国通貨の相互計算を行うシステムを例に扱う
-   以下のような通貨情報レポートを出力することを目的とする

    | 銘柄     | 株数 | 価格    | 合計      |
    | :------- | :--- | :------ | :-------- |
    | IBM      | 1000 | 25 USD  | 25000 USD |
    | Novartis | 40   | 150 CHF | 60000 CHF |
    |          |      | 総計    | 65000 USD |

-   どのようなテストを書けば、レポートを正しく出すコードが完成した事を保証できるかを考える
-   本書では、TODO リストを作成し、作成するテストや作業内容をそこに記していく（太字になっているものが現在対応しているもの）

<!-- prettier-ignore -->
!!! info 
    - $5 + 10CHF = $10 (レートが2:1の場合)
    - **$5 * 2 = $10**

-   TDD は、もっともシンプルなものから対処していくことが推奨される
    -   そのため、本例では、レートを考慮した足し算ではなく、よりシンプルな掛け算から対処していく
-   テストを書く際、初期段階では、用途にあった完璧なインターフェースを作成する
    -   その後、様々な変更を経て、現実的なインターフェースに落とし込んでいく
-   掛け算のテストコードのシンプルな例は以下のようになる

    ```python
    from test_driven_development.muiti_currency_money.money import Dollar


    def test_multiplication():
        five = Dollar(5)
        five.times(2)
        assert five.amount == 10
    ```

-   単純なテストコードを実装した時点で、様々な問題が内在していることに気づく
    -   しかし、一度に全てを完成させようと考えてはいけない
    -   小さいステップを踏むことが大切である
    -   そのため、気づいた問題は TODO として書き留めておく

<!-- prettier-ignore -->
!!! info 
    - $5 + 10CHF = $10 (レートが2:1の場合)
    - **$5 * 2 = $10**
    - amountをprivateにする
    - Dollarの副作用どうする？
    - Moneyの丸め処理どうする？

-   スタート段階では、コンパイルすらできない状態である（Python の場合はランタイムエラー）
-   第一ステップとしては、テストコードがうまく動くはさておき、まずはコンパイルが通るようにする
    1. 空の Dollor クラスを作成する
    1. amount を受け取る空のコンストラクタの定義をする
    1. 空の times メソッドを定義する
    1. amount フィールドを作成する
-   それぞれが小さなステップだが、これらを通してコンパイルが通るようになる（そして、テストコードが失敗する）
    -   この段階で、「多国通貨対応をする」ことではなく、「このテストを通す。その後、新たなテストを作成しそれも通す」事だけを意識すればよく、考慮するスコープを小さくすることができている
-   次のステップでは、テストを愚直に通すことを考える

    -   完璧な解である必要はなく、テストを通すための最小限の変更を行う

    ```python
    class Dollar:
        def __init__(self, amount: int):
            self.amount = 10

        def times(self, multiplier: int):
            pass
    ```

-   これによって、テストを通すことができた
-   更に次のステップとして、コードにある重複を除去することで、リファクタリングを行っていく
    -   ソースコードの変更が必要になった際に、問題となるのはしばしば重複コードである
    -   オブジェクト指向に則ることで、大抵のロジックの重複を取り除くことができる
    -   次のテストに行く前に、重複を除去することで、可能な限り少ない変更で次のテストを通せるようにしておく
-   先ほどのソースコードには、テストを通す為の具体的な値「10」が使用されている
-   これの正体は「5 \* 2」であり、テストコード上にあるデータと同じデータ（=重複コード）が使用されている

    ```python
    class Dollar:
        def __init__(self, amount: int):
            self.amount = amount

        def times(self, multiplier: int):
            self.amount *= 2
    ```

-   この変更によって、「5」の重複を排除することを実現し、すぐにテストを実行し、成功することが確認できる
    -   この変更はいまだに愚かな変更であるが、大切な事は**小さいステップで変更を行い、都度テストが通ることを確認しながら、変更を行う事**である
-   当然この状態ではまだ「2」の重複がある。これは times メソッドを呼び出す際の引数の為、multiplier に置き換える事ができる

    ```python
    class Dollar:
        def __init__(self, amount: int):
            self.amount = amount

        def times(self, multiplier: int):
            self.amount *= multiplier
    ```

<!-- prettier-ignore -->
!!! info 
    - $5 + 10CHF = $10 (レートが2:1の場合)
    - <s>$5 * 2 = $10</s>
    - amountをprivateにする
    - Dollarの副作用どうする？
    - Moneyの丸め処理どうする？

-   以上の一連の流れで、一つのテストを完成させることができた
-   TDD における一連のサイクルは、以下である
    1. 小さいテストを 1 つ書く
    1. すべてのテストを実行し、1 つ失敗すること確認する
    1. テストが通るように変更を行う
    1. 再びテストを実行し、全て成功することを確認する
    1. リファクタリングを行い、重複を除去する
