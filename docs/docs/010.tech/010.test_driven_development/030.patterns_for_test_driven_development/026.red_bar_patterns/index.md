# 第 26 章 レッドバーのパターン

-   この章ではいつどこにテストを書き、いつやめるかを説明する

## 一歩を示すテスト

-   TODO リストから次に書くテストを選ぶときには、そこから何かを学ぶことができ、かつ実装に自信が持てるようなテストを選ぶことを推奨する
-   今ある TODO リストから、次に各テストを決める事は、一概に答えのある問いではない
    -   まだ実装したことがない開発者にとっての一歩は、経験豊かな開発者にとっての 1/10 歩に過ぎない
    -   次の一歩を示すためのテストが TODO リストにない場合は、新しい一歩を記すためのテストを加えることを推奨する
-   筆者は次のテストを決める際に、各実装の明白さを考える
    -   分かり切ってはいないが、書けば動きそうなテストを次のテストとして選択している
-   テストから導き出され育っていくコードは、トップダウンで書かれているように見える
    -   一方で、プログラムは小さな部品を小さく育て、それを組み合わせながら大きくする
    -   つまり、見ようによってはボトムアップであるように見える
-   環境がプログラムに影響し、プログラムも環境に影響を及ぼす相互関係にある
    -   トップダウン、ボトムアップと異なる、自己相似形のフィードバックループとなっている
-   どちらかというと、「既知から未知へ」というメタファーの方が有用だ
    -   自身の持っている知識から導出したり、得られた経験から学んだりしながら、開発を進めていける事を意味する

## はじめのテスト

-   テストの書き始めは、「何もしないこと」のテストから始めると良い

    -   機能を書き始めるときの最初の問いは「この機能はどこに属するべきだろうか」である

        -   それが決まらないことには、テストコードを書き始められない
        -   「1 つずつ解決する」掟の下では、この問いだけに答える必要がある

    -   一方で、しっかりとしたテストを書き始めると、一度に複数の問題に直面している事に気づく

        -   この機能はどこに属するべきか
        -   正しい入力は何か
        -   その入力から得られる正しい出力は何か

    -   正しいテストを最初に作ると、フィードバックを得るまでに時間がかかってしまう

-   一歩を示すテストは、はじめのテストにも適用できる
    -   はじめのテストには、そこから学ぶものがありそうで、かつ、すぐに書けそうなテストを選ぶことが推奨される
    -   既に何回か実装したアプリケーションを再実装している時には、機能が 1 つか 2 つ必要になるテストを書く方がよい

## 説明的なテスト

-   テストが書かれたコードは結合時の問題や不具合報告が少ないこと、そして設計がシンプルで説明がしやすいことが分かる
-   チーム開発を行う上では、TDD を強要するのは難しい
    -   テストを利用して説明してみるのがよい
        -   「こんな感じで Foo と Bar を利用したら、76 になるという理解でいいのか？」
        -   「こんな感じで Foo と Bar があるとき 76 であるが、こう変更すると 67 になる」
    -   チームメンバーが UML のシーケンス図を使用して説明をしてきたら、シーケンス図に出てくるオブジェクトたちをテストコードに書き直して会話をするのも良い

## 学習用テスト

-   チーム外の誰かが書いたソフトウェアでも、新機能を初めて使う際には（かつどんな機能か曖昧なら）、その機能のテストを書いてみても良い
-   依存しているパッケージの新しいバージョンがリリースされたら、まず学習用テストを走らせる
    -   もし学習用テストが失敗したら、自分たちのコードのテストも動きっこない

## 脱線は TODO リストへ

-   技術的な疑問を解消しようとすると脱線しそうなら、TODO リストに加え、元の作業を続けた方がよい
-   新しいアイデアに心惹かれても、本来の仕事に割り込ませると、かえって作業が遅れる
    -   そのアイデアは TODO リストに書いておく

## 回帰テスト

-   不具合が報告された時、まず不具合を再現させる最小のテストケースを書き、失敗を再現させる
    -   そのテストが通るようになったら、不具合が修正されたことになる
-   回帰テストというのは、本来はコードを書いた時に同時に書かれるべきであったテストである
    -   回帰テストを書くときには、書くべきことにどうやったら気づけたかを考えなければならない
-   アプリケーションレベルのテストにも大きな意味がある
    -   何が違っていて、本来はどうあるべきかを顧客と話すときに、きちんとした拠り所になる
-   細かい粒度の回帰テストでは、開発者がテストをより強固にするための方策となる
-   不具合部分を独立してテストするために、リファクタリングが必要になることもある
    -   そのような不具合は、「まだ設計を終えていない」というメッセージである

## 休憩

-   疲れたり手詰まりになったりしたときは、休憩を取るべきである
-   休憩の意義を以下のモデルで示す

    ![](./img/causal_loop.svg)

    -   疲れれば疲れるほど、疲労自体に気づきにくくなり、もっと作業を続け、更に疲労する

-   休憩とは対極の考え方がある。困難な状況に直面している時に、とにかくどんどん推し進めていくやり方だ
    -   しかしこれは、健康や家族、時には自分の命さえも犠牲にしている

## やり直す

-   手詰まりで途方に暮れてしまった時は、コードを捨てて、やり直すのも手である
-   様々な経緯を経て、複雑に絡み合ったコードが出来上がってしまった時には、最初からやり直す方が、結果的に意味の通るコードになる

## 安い机に良い椅子

-   他の家具はケチっても、椅子だけはとにかく良いものを使うことを推奨する
-   背中が痛ければ、良いコードは書けない
